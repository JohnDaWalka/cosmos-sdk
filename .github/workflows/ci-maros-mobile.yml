name: MarOS Mobile CI
on:
  push:
    branches: [ develop, 'feature/*', 'release/*' ]
    paths:
      - 'mobile/**'
      - '.github/workflows/ci-maros-mobile.yml'
  pull_request:
    branches: [ develop ]
    paths:
      - 'mobile/**'
      - '.github/workflows/ci-maros-mobile.yml'

jobs:
  build-test:
    runs-on: macos-14
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        platform: [ ios, watchos, tvos ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select latest Xcode
        run: |
          XCODE_PATH=$(ls -d /Applications/Xcode*.app | sort -Vr | head -n1)
          sudo xcode-select -s "$XCODE_PATH"
          xcodebuild -version
          xcodebuild -showsdks

      - name: Build
        working-directory: mobile/ios
        run: |
          case "${{ matrix.platform }}" in
            ios)
              xcodebuild \
                -project MarOS.xcodeproj \
                -scheme MarOS \
                -destination 'platform=iOS Simulator,name=iPhone 15' \
                -configuration Debug \
                clean build
              ;;
            watchos)
              xcodebuild \
                -project MarOS.xcodeproj \
                -scheme MarOS-watchOS \
                -destination 'platform=watchOS Simulator,name=Apple Watch Series 10 (46mm)' \
                -configuration Debug \
                clean build
              ;;
            tvos)
              xcodebuild \
                -project MarOS.xcodeproj \
                -scheme MarOS-tvOS \
                -destination 'platform=tvOS Simulator,name=Apple TV 4K (3rd generation)' \
                -configuration Debug \
                clean build
              ;;
          esac

      - name: Test (where applicable)
        if: matrix.platform != 'watchos'
        working-directory: mobile/ios
        run: |
          case "${{ matrix.platform }}" in
            ios)
              xcodebuild \
                -project MarOS.xcodeproj \
                -scheme MarOS \
                -destination 'platform=iOS Simulator,name=iPhone 15' \
                test
              ;;
            tvos)
              xcodebuild \
                -project MarOS.xcodeproj \
                -scheme MarOS-tvOS \
                -destination 'platform=tvOS Simulator,name=Apple TV 4K (3rd generation)' \
                test
              ;;
          esac
