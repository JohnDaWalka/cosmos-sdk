name: Apple Platforms CI (iOS, watchOS, tvOS)

# Trigger workflow on push and pull requests to the main branch
on:
  push:
    branches:
      - main
    paths:
      - 'mobile/**'
      - '.github/workflows/apple-platforms.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'mobile/**'
      - '.github/workflows/apple-platforms.yml'

# Use macOS 14 for compatibility with latest Xcode and Apple platforms
jobs:
  # Build and test for iOS platform
  build-ios:
    name: Build and Test iOS
    runs-on: macos-14

    steps:
      # Checkout the MarOS repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Select Xcode version for iOS builds
      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      # Display Xcode version for debugging
      - name: Display Xcode version
        run: xcodebuild -version

      # Build MarOS for iOS platform using xcodebuild
      - name: Build for iOS
        working-directory: mobile/ios
        run: |
          xcodebuild build \
            -project MarOS.xcodeproj \
            -scheme MarOS \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
            -configuration Release \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            ONLY_ACTIVE_ARCH=NO

      # Run tests for iOS platform
      # Tests validate MarOS functionality on iOS
      - name: Test on iOS Simulator
        working-directory: mobile/ios
        run: |
          xcodebuild test \
            -project MarOS.xcodeproj \
            -scheme MarOS \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
            -configuration Release \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO

  # Build and test for watchOS platform
  build-watchos:
    name: Build and Test watchOS
    runs-on: macos-14

    steps:
      # Checkout the MarOS repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Select Xcode version for watchOS builds
      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      # Display Xcode version for debugging
      - name: Display Xcode version
        run: xcodebuild -version

      # Build MarOS for watchOS platform using xcodebuild
      - name: Build for watchOS
        working-directory: mobile/ios
        run: |
          xcodebuild build \
            -project MarOS.xcodeproj \
            -scheme MarOS-watchOS \
            -destination 'platform=watchOS Simulator,name=Apple Watch Series 9 (45mm),OS=latest' \
            -configuration Release \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            ONLY_ACTIVE_ARCH=NO

      # Note: watchOS typically does not support testing in the same way iOS does
      # Tests are generally not run for watchOS builds

  # Build and test for tvOS platform
  build-tvos:
    name: Build and Test tvOS
    runs-on: macos-14

    steps:
      # Checkout the MarOS repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Select Xcode version for tvOS builds
      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      # Display Xcode version for debugging
      - name: Display Xcode version
        run: xcodebuild -version

      # Build MarOS for tvOS platform using xcodebuild
      - name: Build for tvOS
        working-directory: mobile/ios
        run: |
          xcodebuild build \
            -project MarOS.xcodeproj \
            -scheme MarOS-tvOS \
            -destination 'platform=tvOS Simulator,name=Apple TV,OS=latest' \
            -configuration Release \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            ONLY_ACTIVE_ARCH=NO

      # Run tests for tvOS platform
      # Tests validate MarOS functionality on tvOS
      - name: Test on tvOS Simulator
        working-directory: mobile/ios
        run: |
          xcodebuild test \
            -project MarOS.xcodeproj \
            -scheme MarOS-tvOS \
            -destination 'platform=tvOS Simulator,name=Apple TV,OS=latest' \
            -configuration Release \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO
