name: ci
on:
  push:
    branches: [ develop, 'feature/*', 'release/*' ]
  pull_request:
    branches: [ develop ]

jobs:
  apple-build-test:
    runs-on: macos-14
    strategy:
      fail-fast: false
      matrix:
        platform: [ ios, tvos, watchos ]
    steps:
      - uses: actions/checkout@v4
      - name: Select latest Xcode
        run: |
          XCODE_PATH=$(ls -d /Applications/Xcode*.app | sort -Vr | head -n1)
          sudo xcode-select -s "$XCODE_PATH"
          xcodebuild -version
          xcodebuild -showsdks
      - name: Build
        run: |
          case "${{ matrix.platform }}" in
            ios)
              xcodebuild \
                -project mobile/ios/MarOS.xcodeproj \
                -scheme MarOS \
                -destination 'platform=iOS Simulator,name=iPhone 15' \
                -configuration Debug \
                clean build | xcpretty
              ;;
            tvos)
              xcodebuild \
                -project mobile/ios/MarOS.xcodeproj \
                -scheme MarOS-tvOS \
                -destination 'platform=tvOS Simulator,name=Apple TV 4K (3rd generation)' \
                -configuration Debug \
                clean build | xcpretty
              ;;
            watchos)
              xcodebuild \
                -project mobile/ios/MarOS.xcodeproj \
                -scheme MarOS-watchOS \
                -destination 'platform=watchOS Simulator,name=Apple Watch Series 10 (46mm)' \
                -configuration Debug \
                clean build | xcpretty
              ;;
          esac
      - name: Test (iOS & tvOS only)
        if: matrix.platform != 'watchos'
        run: |
          case "${{ matrix.platform }}" in
            ios)
              xcodebuild \
                -project mobile/ios/MarOS.xcodeproj \
                -scheme MarOS \
                -destination 'platform=iOS Simulator,name=iPhone 15' \
                test | xcpretty
              ;;
            tvos)
              xcodebuild \
                -project mobile/ios/MarOS.xcodeproj \
                -scheme MarOS-tvOS \
                -destination 'platform=tvOS Simulator,name=Apple TV 4K (3rd generation)' \
                test | xcpretty
              ;;
          esac

  android-build-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: mobile
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - name: Gradle cache
        uses: gradle/actions/setup-gradle@v3
      - name: Build & Test
        run: ./gradlew :core:build :androidApp:assembleDebug :androidApp:testDebugUnitTest